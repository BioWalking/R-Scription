Data pre-processing with Seurat package
The Seurat pipeline was applied to each sample and for combined analyses (Butler et al., 2018). Genes that were expressed in less than 5 cells and cells that expressing less than 500, or more than 9,000 genes (outliers), or with a percentage of mitochondrial genes higher than 10% were excluded from further analyses. 
To accurately separate tumor cells and stromal cells in each sample, we merged datasets from different biopsies, this strategy outperforms single sample clustering and efficiently separates stromal cells in samples with higher tumor purities and low stromal fractions (e.g., Melan-2, Breast-3, Lung-1 and Ovarian-1) and also improve the identification of rare cell types (e.g., astrocytes). Following identification with known marker genes, we extracted all stromal cells for each patient.
To reveal the shared sources of biological variation (conserved sub-structures) between BrM-associated stromal cells, we used the integration tool for scRNAseq data sets provided by Seurat package. The top 2,000 highly variable genes of each sample were detected by variance stabilizing transformation method in FindVariableFeatures. Anchors across the 14 datasets were then identified and the datasets were integrated using the default parameters. Before clustering, the number of counts and percentage of mitochondrial genes were regressed out using a negative binomial model (function vars.to.regress). We did not regress cell cycle genes because we did not observe cell cycle genes driving clusters in the stroma. Principal component analysis (PCA) was performed with PCA function and dataset dimensionality kept for downstream analysis was determined heurustically with Elbowplot and ScoreJackStraw functions. A UMAP dimensional reduction was performed on the scaled matrix using the first 18 PCA components to obtain a two-dimensional representation. For clustering, we used the function FindClusters that implements SNN (shared nearest neighbor) modularity optimization-based clustering algorithm on the first 18 PCA components with resolution 0.5 - 1.5. A resolution of 1.3 was chosen for the analysis, in our hands the most informative resolution but the result was generally robust to hyperparameter choices.
For clustering of individual samples, a UMAP dimensional reduction was performed on the scaled matrix using the first 10 PCA components and a FindClusters function was set at resolution of 0.5. For clustering of all combined MTCs, normalized counts of annotated MTCs of all samples were merged, centered, and scaled, dataset dimensionality for downstream analysis was determined heurustically with Elbowplot and ScoreJackStraw functions, finally the UMAP dimensional reduction was performed using the first 20 PCA components.
